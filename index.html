<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Marker AR Debug v2</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- AR.js for A-Frame -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.js"></script>

  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui}
    #wrap{height:100%;width:100%;position:relative;overflow:hidden}
    .hud { position: absolute; left:12px; top:12px; z-index:5; background:rgba(0,0,0,0.6); padding:8px 10px; border-radius:8px; max-width:70%; }
    .hint { position:absolute; left:12px; bottom:12px; z-index:5; background:rgba(0,0,0,0.6); padding:8px 10px; border-radius:8px; }
    .status { font-size:14px; line-height:1.35; }
    .btn { display:inline-block; margin-top:8px; padding:6px 8px; border-radius:6px; background:#0b74de; color:white; text-decoration:none; font-size:13px;}
    #debugVideo { position:absolute; right:12px; top:12px; z-index:4; width:120px; height:90px; background:#222; border-radius:8px; object-fit:cover; transform: scaleX(-1); } /* mirrored for front camera */
    #overlayLog { position:absolute; right:12px; bottom:12px; z-index:5; background:rgba(0,0,0,0.5); padding:6px 8px; border-radius:8px; font-size:12px; max-width:28%; color:#fff; }
  </style>
</head>
<body>
  <div id="wrap">
    <div class="hud">
      <div class="status" id="status">Status: initializing...</div>
      <div style="margin-top:6px;font-size:13px">Open in Chrome on Android or Safari on iPhone. Not inside Instagram/WhatsApp.</div>
    </div>

    <video id="debugVideo" autoplay playsinline muted></video>
    <div id="overlayLog">log: ...</div>

    <div class="hint">Tip: allow camera → point at printed "hiro" marker (10–15 cm). If black, try another phone/browser.</div>

    <!-- AR scene with forced AR.js sourceFacingMode and explicit sizes -->
    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true;"
      vr-mode-ui="enabled: false"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; sourceWidth: 640; sourceHeight: 480; sourceFacingMode: environment;">
      
      <a-assets>
        <!-- Preload the model; ensure model.glb is in same folder -->
        <a-asset-item id="myModel" src="model.glb"></a-asset-item>
      </a-assets>

      <a-marker preset="hiro">
        <a-entity id="model"
                  gltf-model="#myModel"
                  scale="0.5 0.5 0.5"
                  rotation="0 180 0"
                  position="0 0 0"
                  animation-mixer
                  visible="false">
        </a-entity>

        <a-plane rotation="-90 0 0" width="1.5" height="1.5" position="0 -0.001 0" material="opacity:0.0;"></a-plane>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const debugVideo = document.getElementById('debugVideo');
    const overlayLog = document.getElementById('overlayLog');

    function setStatus(text) { statusEl.textContent = 'Status: ' + text; console.log(text); overlayLog.textContent = 'log: ' + text; }

    // Try to get the environment (rear) camera first. If not available, fallback.
    async function startDebugStream() {
      const constraintsPreferEnv = { video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false };
      const constraintsFallback = { video: true, audio: false };

      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraintsPreferEnv);
        debugVideo.srcObject = stream;
        setStatus('Camera stream active (environment).');
        return stream;
      } catch (e) {
        console.warn('Env camera failed, trying default camera', e);
        try {
          const stream2 = await navigator.mediaDevices.getUserMedia(constraintsFallback);
          debugVideo.srcObject = stream2;
          setStatus('Camera stream active (default).');
          return stream2;
        } catch (err) {
          console.error('Camera failed', err);
          setStatus('Camera permission denied or not available.');
          return null;
        }
      }
    }

    // Attach debug stream immediately so you can visually confirm camera frames
    startDebugStream();

    // A-Frame model load / error handlers
    document.addEventListener('DOMContentLoaded', () => {
      const modelEnt = document.getElementById('model');

      modelEnt.addEventListener('model-loaded', () => {
        setStatus('Model loaded successfully. Waiting for marker.');
        modelEnt.setAttribute('visible', 'true');
      });

      modelEnt.addEventListener('model-error', (evt) => {
        setStatus('Model failed to load. Check model path.');
        console.error('Model error', evt);
      });

      // Marker found / lost events
      const marker = document.querySelector('a-marker');
      marker.addEventListener('markerFound', () => { setStatus('Marker FOUND — model should appear.'); });
      marker.addEventListener('markerLost', () => { setStatus('Marker LOST'); });
    });

    // Additional check: ensure page is not inside an in-app browser
    (function detectInApp() {
      const ua = navigator.userAgent || '';
      const inApp = /Instagram|FBAN|FBAV|Twitter|WhatsApp|Line|Messenger/i.test(ua);
      if (inApp) {
        setStatus('Detected in-app browser — open in Chrome/Safari for camera access.');
      }
    })();

    // Print extra debug info to console (helpful if you use remote debugging)
    console.log('UserAgent:', navigator.userAgent);
    navigator.mediaDevices && navigator.mediaDevices.enumerateDevices && navigator.mediaDevices.enumerateDevices()
      .then(devs => console.log('Devices:', devs))
      .catch(e => console.warn('Could not list devices', e));
  </script>
</body>
</html>
