<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Marker AR Debug</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- AR.js for A-Frame -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.js"></script>

  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui}
    #wrap{height:100%;width:100%;position:relative;overflow:hidden}
    .hud { position: absolute; left:12px; top:12px; z-index:3; background:rgba(0,0,0,0.6); padding:8px 10px; border-radius:8px;}
    .hint { position:absolute; left:12px; bottom:12px; z-index:3; background:rgba(0,0,0,0.6); padding:8px 10px; border-radius:8px;}
    .status { font-size:14px; line-height:1.35; }
    .btn { display:inline-block; margin-top:8px; padding:6px 8px; border-radius:6px; background:#0b74de; color:white; text-decoration:none; font-size:13px;}
  </style>
</head>
<body>
  <div id="wrap">
    <div class="hud">
      <div class="status" id="status">Status: waiting</div>
      <a class="btn" id="open-in-browser" href="#" style="display:none;">Open in Browser</a>
    </div>

    <div class="hint">Tip: Allow camera → point at printed "hiro" marker (10–15cm). If black screen, open in Chrome/Safari, not inside apps.</div>

    <!-- AR scene -->
    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true;"
      arjs="sourceType: webcam; debugUIEnabled: false;"
      >
      <a-assets>
        <!-- Preload model; ensure model.glb is in the same folder on GitHub Pages -->
        <a-asset-item id="myModel" src="model.glb"></a-asset-item>
      </a-assets>

      <!-- Marker: preset="hiro" -->
      <a-marker preset="hiro">
        <a-entity id="model"
                  gltf-model="#myModel"
                  scale="0.5 0.5 0.5"
                  rotation="0 180 0"
                  position="0 0 0"
                  animation-mixer
                  visible="false">
        </a-entity>

        <a-plane rotation="-90 0 0" width="1.5" height="1.5" position="0 -0.001 0" material="opacity:0.0;"></a-plane>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const openBtn = document.getElementById('open-in-browser');

    function setStatus(text) { statusEl.textContent = 'Status: ' + text; console.log(text); }

    // Check if opened inside an in-app webview
    function isInAppBrowser() {
      const ua = navigator.userAgent || '';
      // crude check: many in-app browsers contain instagram, fb, twitter, whatsapp
      return /Instagram|FBAN|FBAV|Twitter|WhatsApp|Line|Messenger/i.test(ua);
    }

    if (isInAppBrowser()) {
      setStatus('Detected in-app browser. Please open this link in Chrome/Safari for camera access.');
      openBtn.style.display = 'inline-block';
      openBtn.href = window.location.href; // user can long-press and "open in browser"
    } else {
      setStatus('Loaded in regular browser. Requesting camera permission...');
    }

    // Events for the model entity
    const modelEnt = document.getElementById('model');

    modelEnt.addEventListener('model-loaded', () => {
      setStatus('Model loaded successfully. Waiting for marker and camera.');
      modelEnt.setAttribute('visible', 'true');
      console.log('Model loaded event ->', modelEnt);
    });

    modelEnt.addEventListener('model-error', (evt) => {
      setStatus('Model failed to load — check model path/filename or console for details.');
      console.error('Model error', evt);
    });

    // Listen to AR.js camera start/stop via the scene's renderer (best-effort)
    document.querySelector('a-scene').addEventListener('renderstart', () => {
      console.log('A-Frame renderstart');
    });

    // Extra: try to detect if camera stream is active
    async function checkCameraStream() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const tracks = stream.getVideoTracks();
        if (tracks && tracks.length > 0) {
          setStatus('Camera stream active. Now point at marker.');
          tracks.forEach(t=>t.stop()); // stop the test stream
          return true;
        }
      } catch (e) {
        setStatus('Camera permission denied or blocked. Open in Chrome/Safari and allow camera.');
        console.error('getUserMedia error', e);
        return false;
      }
    }

    // Run camera check after a short delay so the page can settle
    setTimeout(() => {
      checkCameraStream();
    }, 800);
  </script>
</body>
</html>
